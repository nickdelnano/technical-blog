<!DOCTYPE html>
<html lang="en-gb"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="content-type" content="text/html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title itemprop="name">AWS Lake Formation with Self Hosted Query Engines | Nick Del Nano&#39;s blog</title>
<meta property="og:title" content="AWS Lake Formation with Self Hosted Query Engines | Nick Del Nano&#39;s blog" />
<meta name="twitter:title" content="AWS Lake Formation with Self Hosted Query Engines | Nick Del Nano&#39;s blog" />
<meta itemprop="name" content="AWS Lake Formation with Self Hosted Query Engines | Nick Del Nano&#39;s blog" />
<meta name="application-name" content="AWS Lake Formation with Self Hosted Query Engines | Nick Del Nano&#39;s blog" />
<meta property="og:site_name" content="Awesome hugo blog" />

<meta name="description" content="Minimal Hugo blog theme with light and dark mode support">
<meta itemprop="description" content="Minimal Hugo blog theme with light and dark mode support" />
<meta property="og:description" content="Minimal Hugo blog theme with light and dark mode support" />
<meta name="twitter:description" content="Minimal Hugo blog theme with light and dark mode support" />

<meta property="og:locale" content="en-gb" />
<meta name="language" content="en-gb" />

  <link rel="alternate" hreflang="en-gb" href="http://localhost:1313/aws-lake-formation-self-hosted-engines/" title="English" />






<meta name="generator" content="Hugo 0.138.0">

    
    <meta property="og:url" content="http://localhost:1313/aws-lake-formation-self-hosted-engines/">
  <meta property="og:site_name" content="Nick Del Nano&#39;s blog">
  <meta property="og:title" content="AWS Lake Formation with Self Hosted Query Engines">
  <meta property="og:description" content="Lake Formation is a neat service that provides a better authorization abstraction for data lake objects than IAM. What do I mean by “better”?
Friendlier for data related roles (analysts, data engineers, data scientists, etc) to understand and use These roles work with data lake table names. They don’t care about S3 paths. Possible to audit permissions. aws lake formation list-permissions replaces … parsing IAM policies? Lake Formation provides its own permissions model that augments the IAM permissions model. Lake Formation permissions model enables fine-grained access to data stored in data lakes through a simple grant or revoke mechanism, much like a relational database management system (RDBMS). https://docs.aws.amazon.com/lake-formation/latest/dg/what-is-lake-formation.html">
  <meta property="og:locale" content="en_gb">
  <meta property="og:type" content="article">
    <meta property="article:published_time" content="2024-09-15T00:00:00-08:00">
    <meta property="article:modified_time" content="2024-09-15T00:00:00-08:00">


    
    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="AWS Lake Formation with Self Hosted Query Engines">
  <meta name="twitter:description" content="Lake Formation is a neat service that provides a better authorization abstraction for data lake objects than IAM. What do I mean by “better”?
Friendlier for data related roles (analysts, data engineers, data scientists, etc) to understand and use These roles work with data lake table names. They don’t care about S3 paths. Possible to audit permissions. aws lake formation list-permissions replaces … parsing IAM policies? Lake Formation provides its own permissions model that augments the IAM permissions model. Lake Formation permissions model enables fine-grained access to data stored in data lakes through a simple grant or revoke mechanism, much like a relational database management system (RDBMS). https://docs.aws.amazon.com/lake-formation/latest/dg/what-is-lake-formation.html">


    

    <link rel="canonical" href="http://localhost:1313/aws-lake-formation-self-hosted-engines/">
    <link href="/style.min.2d921c18cf1ec555ffc03d59a8adc211c402c68c930c27d6a0c306ab175a8d09.css" rel="stylesheet">
    <link href="/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css" rel="stylesheet">

    
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg">
    <link rel="shortcut icon" href="/favicon.ico">




<link rel="manifest" href="http://localhost:1313/site.webmanifest">

<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="msapplication-TileColor" content="#2d89ef">
<meta name="theme-color" content="#434648">

    
    <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">

    
    
</head>
<body data-theme = "dark" class="notransition">

<script src="/js/theme.js"></script>

<div class="navbar" role="navigation">
    <nav class="menu" aria-label="Main Navigation">
        <a href="http://localhost:1313/" class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" 
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
stroke-linejoin="round" class="feather feather-home">
<title>Home</title>
<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
<polyline points="9 22 9 12 15 12 15 22"></polyline>
</svg>
        </a>
        <input type="checkbox" id="menu-trigger" class="menu-trigger" />
        <label for="menu-trigger">
            <span class="menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentColor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7L3.40726 7"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488L3.49301 3.51488"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"></path><path stroke-linecap="round" stroke-linejoin="round" d="M0.5 12.5V1.5C0.5 0.947715 0.947715 0.5 1.5 0.5H12.5C13.0523 0.5 13.5 0.947715 13.5 1.5V12.5C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C0.947715 13.5 0.5 13.0523 0.5 12.5Z"></path></svg>
            </span>
        </label>

        <div class="trigger">
            <ul class="trigger-container">
                
                
                <li>
                    <a class="menu-link " href="/">
                        Home
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/posts/">
                        Posts
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/about/">
                        About
                    </a>
                    
                </li>
                
                <li class="menu-separator">
                    <span>|</span>
                </li>
                
                
            </ul>
            <a id="mode" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
            </a>
        </div>
    </nav>
</div>

<div class="wrapper post">
    <main class="page-content" aria-label="Content">
        <article>
            <header class="header">
                <h1 class="header-title">AWS Lake Formation with Self Hosted Query Engines</h1>
                
                
                
                <div class="post-meta">
                    <time datetime="2024-09-15T00:00:00-08:00" itemprop="datePublished"> 15 Sep 2024 </time>
                </div>
                
            </header>
            
    
    <details class="toc" ZgotmplZ>
        <summary><b>Table of Contents</b></summary>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#query-engine-compatibility">Query Engine Compatibility</a></li>
    <li><a href="#expanded-compatibility-with-apache-iceberg">Expanded Compatibility with Apache Iceberg</a></li>
    <li><a href="#addendum">Addendum</a></li>
  </ul>
</nav>
    </details>
            <div class="page-content">
                <p>Lake Formation is a neat service that provides a better authorization abstraction for data lake objects than IAM. What do I mean by &ldquo;better&rdquo;?</p>
<ul>
<li>Friendlier for data related roles (analysts, data engineers, data scientists, etc) to understand and use
<ul>
<li>These roles work with data lake table names. They don&rsquo;t care about S3 paths.</li>
</ul>
</li>
<li>Possible to audit permissions.  <em>aws lake formation list-permissions</em> replaces &hellip; parsing IAM policies?</li>
</ul>
<blockquote>
<p>Lake Formation provides its own permissions model that augments the IAM permissions model. Lake Formation permissions model enables fine-grained access to data stored in data lakes through a simple grant or revoke mechanism, much like a relational database management system (RDBMS).
<a href="https://docs.aws.amazon.com/lake-formation/latest/dg/what-is-lake-formation.html">https://docs.aws.amazon.com/lake-formation/latest/dg/what-is-lake-formation.html</a></p>
</blockquote>
<p>With Lake Formation, IAM permissions on S3 (data) and Glue (metadata) resources become <em>GRANT</em> statements. If you have managed IAM change management in an enterprise, or even if you have written an IAM policy just one time, this will be a welcome change to you.</p>
<p>Bringing data lake permissions into the data world is a huge value add for the triad of data users, the data platform team and a security organization. <em>But there are prerequisites, and hopefully your deployment meets them. If not, then maybe this post will help you.</em></p>
<h2 id="query-engine-compatibility">Query Engine Compatibility</h2>
<p>To enable <a href="https://docs.aws.amazon.com/lake-formation/latest/dg/how-it-works.html">Lake Formation&rsquo;s implementation</a>, it requires using <a href="https://docs.aws.amazon.com/lake-formation/latest/dg/service-integrations.html">AWS hosted query engines</a>. If you are self hosting your query engine, or if you are using an engine not supported in Lake Formation, your only option is to implement the <a href="https://docs.aws.amazon.com/lake-formation/latest/dg/using-cred-vending.html">credential vending API</a>. It is possible – <a href="https://docs.starburst.io/latest/security/aws-lake-formation.html">vendors</a> in the space have done this – but what if you don&rsquo;t want to, or you simply want an open source solution?</p>
<h2 id="expanded-compatibility-with-apache-iceberg">Expanded Compatibility with Apache Iceberg</h2>
<p>Enter Iceberg&rsquo;s <a href="https://github.com/apache/iceberg/blob/main/aws/src/main/java/org/apache/iceberg/aws/lakeformation/LakeFormationAwsClientFactory.java#L51">LakeFormationAwsClientFactory</a> class.</p>
<p>This was <a href="https://github.com/apache/iceberg/pull/4280">contributed by AWS</a> &ndash; plausibly for use with their query engine services &ndash; but it works in the case of a single party. Example configuration, assuming your catalog is named <code>iceberg</code>:</p>
<blockquote>
<p>spark.sql.catalog.iceberg.client.factory=org.apache.iceberg.aws.lakeformation.LakeFormationAwsClientFactory
spark.sql.catalog.iceberg.client.assume-role.arn=arn:aws:iam::&lt;account_id&gt;:role/your-role
spark.sql.catalog.iceberg.glue.lakeformation-enabled=true
spark.sql.catalog.iceberg.client.assume-role.tags.LakeFormationAuthorizedCaller=&lt;tag_registered_to_lake_formation&gt;
spark.sql.catalog.iceberg.client.assume-role.region=us-east-1
spark.sql.catalog.iceberg.glue.account-id=&lt;account_id&gt;</p>
</blockquote>
<p><code>spark.sql.catalog.iceberg.client.assume-role.arn</code> can be the same as the current IAM. It will need a policy to assume itself with a <a href="https://docs.aws.amazon.com/lake-formation/latest/dg/permitting-third-party-call.html">session tag that is registered to Lake Formation</a> and has the value as that of <code>spark.sql.catalog.iceberg.client.assume-role.tags.LakeFormationAuthorizedCaller</code>.</p>
<p>Now you can integrate any Iceberg compatible query engine with Lake Formation permissions. For my case this was open source Spark and Flink.</p>
<p>There is an important limitation:  Lake Formation row and column security policies cannot be securely applied. As part of the <a href="https://docs.aws.amazon.com/lake-formation/latest/dg/roles-and-responsibilities.html">credential vending contract</a>, the third-party must not leak credentials and must return only filtered data to users. This is not applicable in this case since there is only one party and the application will access the credentials. If this limitation is not a blocker for you, then you can enjoy Lake Formation support in all of your query engines.</p>
<h2 id="addendum">Addendum</h2>
<p>The Lake Formation implementation in Iceberg does not work to create tables. The integration test in the repo fails (and is not run on CI? Probably because it requires an AWS account with broad permissions on the IAM service).</p>
<p>I&rsquo;ve filed <a href="https://github.com/apache/iceberg/issues/10226">issue #10226</a> about this.</p>
<p>This can be worked around by</p>
<ul>
<li>Creating a table using Glue APIs. My use-case is for client IAMs to have no S3 permissions and only Lake Formation grants, so I use <code>glue create-table</code> with <code>--open-table-format-input</code>. See <a href="https://docs.aws.amazon.com/lake-formation/latest/dg/creating-iceberg-tables.html">here</a>.</li>
<li>Creating a separate catalog instance without the Lake Formation properties and run DDL through this catalog.</li>
</ul>

            </div>
        </article></main>
</div>
<footer class="footer">
    <span class="footer_item"> </span>
    &nbsp;

    <div class="footer_social-icons">
<a href="https://github.com/hugo-sid" target="_blank" rel="noopener noreferrer me"
    title="Github">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
    </path>
</svg>
</a>
<a href="https://twitter.com" target="_blank" rel="noopener noreferrer me"
    title="Twitter">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z">
    </path>
</svg>
</a>
<a href="/index.xml" target="_blank" rel="noopener noreferrer me"
    title="Rss">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 11a9 9 0 0 1 9 9" />
    <path d="M4 4a16 16 0 0 1 16 16" />
    <circle cx="5" cy="19" r="1" />
</svg>
</a>
</div>
    <small class="footer_copyright">
        © 2024 Sidharth R.
        Powered by <a href="https://github.com/hugo-sid/hugo-blog-awesome" target="_blank" rel="noopener">Hugo blog awesome</a>.
    </small>
</footer><a href="#" title="Go to top" id="totop">
    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" stroke="currentColor" viewBox="0 96 960 960">
    <path d="M283 704.739 234.261 656 480 410.261 725.739 656 677 704.739l-197-197-197 197Z"/>
</svg>

</a>


    




    
    
        
    

    
    
        
    



    
    <script async src="http://localhost:1313/js/main.js" ></script>

    

</body>
</html>
